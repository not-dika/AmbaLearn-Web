<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ course_title }} - AmbaLearn</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <style>
        /* --- Sidebar Icon + Text Fix --- */
        .drawer-list .icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            /* fix unwanted 200px width */
            height: 20px;
            /* keep icons visually aligned */
            font-size: 20px;
            margin-right: 6px;
            vertical-align: middle;
        }

        /* --- Center the "Start Lesson" Button --- */
        .start-button-container {
            display: flex !important;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
        }

        .start-button {
            background-color: var(--color-primary, #4CAF50);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .start-button:hover {
            background-color: #43a047;
        }

        /* --- Placeholder / Background Text --- */
        .chat-placeholder {
            text-align: center;
            color: var(--color-text-dim, #777);
            font-size: 1.1rem;
            line-height: 1.6;
            margin-top: 40%;
        }

        .chat-placeholder strong {
            color: var(--color-primary, #4CAF50);
            display: block;
            margin-bottom: 0.25rem;
        }
    </style>
</head>

<body>

    <aside class="drawer">
        <div class="drawer-header">
            AmbaLearn Lessons
        </div>

        <div class="drawer-content">
            <ul class="drawer-list">
                <li>
                    <a href="{{ url_for('homepage') }}">
                        <span class="material-icons icon">arrow_back</span>
                        Back to Main Menu
                    </a>
                </li>
            </ul>
            <div class="list-header">Lessons</div>
            <ul class="drawer-list">
                {% for step in steps %}
                <li>
                    <a href="#" class="lesson-step-btn" data-step-number="{{ step.step_number }}">
                        <span class="material-icons icon">menu_book_outlined</span>
                        {{ step.title }}
                    </a>
                </li>
                {% else %}
                <li>
                    <a href="#" style="color: var(--color-text-dim); pointer-events: none;">
                        <span class="material-icons icon">info</span>
                        No steps in this course
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
    </aside>

    <main class="main-content">
        <header class="app-bar">
            <span class="title">{{ course_title }}</span>
        </header>

        <div class="page-body" id="page-body">
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-placeholder" id="chat-placeholder">
                        <strong>Welcome to {{ course_title }}</strong>
                        Select a lesson from the sidebar to begin your journey.
                    </div>
                </div>
            </div>
        </div>

        <div id="input-bar-container">
            <div class="start-button-container" id="start-btn-container" style="display: none;">
                <button class="start-button" id="start-lesson-btn">Start Lesson</button>
            </div>

            <div class="input-bar" id="chat-input-container" style="display: none;">
                <form id="chat-form">
                    <input type="text" id="message-input" placeholder="Type your answer..." autocomplete="off">
                    <button type="submit" id="send-button">
                        <span class="material-icons">send</span>
                    </button>
                </form>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const chatMessages = document.getElementById('chat-messages');
            const startBtnContainer = document.getElementById('start-btn-container');
            const startLessonBtn = document.getElementById('start-lesson-btn');
            const chatInputContainer = document.getElementById('chat-input-container');
            const chatForm = document.getElementById('chat-form');
            const messageInput = document.getElementById('message-input');
            const chatPlaceholder = document.getElementById('chat-placeholder');

            const COURSE_UID = "{{ course_uid }}";
            let currentStepNumber = null;

            // --- Helper to load history ---
            // --- Helper to load history ---
            async function loadLessonHistory(stepNumber, lessonTitle) {
                currentStepNumber = stepNumber;
                clearChatUI();
                addMessageToUI(`Loading: ${lessonTitle}...`, 'system');
                
                // --- STEP 1: Hide BOTH controls while loading ---
                chatInputContainer.style.display = 'none';
                startBtnContainer.style.display = 'none';

                try {
                    // --- STEP 2: Fetch history ---
                    const getHistoryUrl = `{{ url_for('api_course_chat', course_uid=course_uid, step_number=0) }}`.replace('/0', `/${stepNumber}`);
                    const response = await fetch(getHistoryUrl, { method: 'GET' });
                    
                    clearChatUI(); // Clear "Loading..."

                    if (response.ok) {
                        // --- STEP 3: 200 OK (History Found / Already Started) ---
                        const data = await response.json(); // Parse the history
                        
                        data.history.forEach(msg => {
                            if (msg.role !== 'system') {
                                addMessageToUI(msg.content, msg.role);
                            }
                        });

                        // Show ONLY chat bar
                        chatInputContainer.style.display = 'block';
                        startBtnContainer.style.display = 'none'; // <-- Button is hidden
                        messageInput.focus();

                    } else {
                        // --- STEP 4: 404 Not Found (New Lesson) ---
                        addMessageToUI(`Selected: ${lessonTitle}`, 'system');
                        addMessageToUI('Click "Start Lesson" when youâ€™re ready to begin.', 'system');
                        
                        // Show ONLY start button
                        chatInputContainer.style.display = 'none';
                        startBtnContainer.style.display = 'flex'; // <-- Button is shown
                    }
                } catch (error) {
                    // --- Network error or other failure ---
                    clearChatUI();
                    addMessageToUI(`Error loading lesson: ${error.message}`, 'system');
                    chatInputContainer.style.display = 'none';
                    startBtnContainer.style.display = 'none';
                }
            }

            // --- When user clicks a lesson ---
            document.querySelectorAll('.lesson-step-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const stepNumber = e.currentTarget.dataset.stepNumber;
                    if (stepNumber === currentStepNumber) return; // Don't reload if active

                    const lessonTitle = e.currentTarget.textContent.trim();
                    await loadLessonHistory(stepNumber, lessonTitle);
                });
            });

            // --- When user clicks "Start Lesson" ---
            startLessonBtn.addEventListener('click', async () => {
                if (!currentStepNumber) return;

                startBtnContainer.style.display = 'none';
                chatInputContainer.style.display = 'block';
                clearChatUI();
                addMessageToUI('Starting lesson...', 'system');

                try {
                    const response = await fetch(
                        `{{ url_for('api_course_chat', course_uid=course_uid, step_number=0) }}`.replace('/0', `/${currentStepNumber}`),
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ start: true })
                        }
                    );
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);

                    addMessageToUI(data.reply, 'assistant');
                    messageInput.focus();
                } catch (error) {
                    addMessageToUI(`Error starting lesson: ${error.message}`, 'system');
                }
            });

            // --- Handle chat form submit ---
            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const message = messageInput.value.trim();
                if (!message || !currentStepNumber) return;

                addMessageToUI(message, 'user');
                messageInput.value = '';

                try {
                    const response = await fetch(
                        `{{ url_for('api_course_chat', course_uid=course_uid, step_number=0) }}`.replace('/0', `/${currentStepNumber}`),
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: message })
                        }
                    );
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);
                    addMessageToUI(data.reply, 'assistant');
                } catch (error) {
                    addMessageToUI(`Error: ${error.message}`, 'system');
                }
            });

            // --- Helpers ---
            function clearChatUI() {
                chatMessages.innerHTML = '';
                chatPlaceholder.style.display = 'none';
            }

            function addMessageToUI(text, role) {
                chatPlaceholder.style.display = 'none';
                const messageBubble = document.createElement('div');
                messageBubble.classList.add('message-bubble', role);
                messageBubble.textContent = text;
                chatMessages.appendChild(messageBubble);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        });

    </script>
</body>

</html>